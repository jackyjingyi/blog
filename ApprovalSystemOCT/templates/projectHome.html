{% extends 'projectBase.html' %}
{% load guardian_tags %}
{% block content %}
    <div class="row">
        <div class="col-md-12" id="timeSelect">
            <div class="data-list-filter">
                <label class="dp-inline-block-1 v-middle m-b-none">立&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;项：</label>
                {% for item in time_interval %}
                    <a class="btn btn-link dp-inline-block-1" data-action="setTime"
                       data-days="{{ item.0 }}">{{ item.1 }}</a>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-12" id="statusSelect">
            <div class="z-index-1 m-b-none">
                <label class="inline v-middle m-b-none">状&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;态：</label>
                {% for item in status_list %}
                    <a class="btn btn-link" data-id="{{ item.0 }}" data-action="setStatus">{{ item.1 }}</a>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-12">
            <div class="form-group z-index-1">
                <label class="inline" for="keywordSearch">搜&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;索：</label>
                <input class="form-control input-sm width-300 inline v-middle" type="text" name="keyword"
                       id="keywordSearch"
                       placeholder="请输入关键字"/>
            </div>
        </div>
        <div class="col-md-12">
            <div class="border-bottom p-b-sm">
                <button class="btn btn-primary" data-action="search">查询</button>
                <button class="btn btn-default" data-action="refreshBtn">重置条件</button>
            </div>
        </div>
    </div>
    <div class="row m-b-sm m-t-xs p-t-sm">
        <div class="col-md-9 filter-result-col">
        <span>
            筛选条件<span id="setTimeResult" class="badge badge-success backselect"></span><span id="setStatusResult"
                                                                                             class="badge badge-success backselect"></span><span
                id="keywordResult" class="badge badge-success backselect"></span>：共
            <span id="totalBySearch"></span>
             个项目
        </span>
        </div>
        <div class="col-md-3 text-right">
            <button class="btn btn-white" data-action="exportDetails">导出</button>
            <button type="button" class="btn btn-primary" data-action="setField" title="设置字段">
                <span>
                    <i class="fa fa-list"></i>
                    <span class="caret m-t-n-xs"></span>
                </span>
            </button>
        </div>
    </div>
    <div class="data-list-box" style="position: static;zoom:1;">
        <div class="data-list-container">
            <div class="project-list of-auto m-scroll-box">
                {% block content1 %}
                    <table class="table table-bordered table-hover cell-border dataTable">
                        <thead style="position: relative;zoom: 1;">
                        <tr>
                            <th colspan="sorting" data-action="sort" data-code="projectNo" data-type="0">
                                项目编号
                            </th>
                            <th data-code="projectName" data-type="0">项目名称</th>
                            <th data-code="createCompany" data-type="2">创建人
                                <a class="icon-filter pull-right" id="filter_createCompany">
                                    <i class="icon iconfont icon-shaixuan"></i>
                                </a>
                            </th>
                            {% if user.is_authenticated %}
                                <th data-code="operation" data-type="3">
                                    操作
                                </th>
                            {% endif %}
                        </tr>
                        </thead>
                        <tbody class="displayProcessObj">

                        {% for item in process %}
                            <tr class="curp" data-id="{{ item.pk }}">
                                <td data-code="projcetNo"><a href="{% url 'project_detail' item.pk %}">{{ item.pk }}</a>
                                </td>
                                <td data-code="projectName">{{ item.get_tasks.last.get_steps.last.step_attachment.get_attachment.first.project_name }}</td>
                                <td data-code="createCompany">{{ item.process_owner.first_name }}</td>
                                {% get_obj_perms user for item as "process_var" %}
                                <td>

                                    {% for pv in process_var %}
                                        <button>{{ pv }}</button>
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% endblock %}
            </div>
        </div>
    </div>

    <script>

        $(document).ready(function () {
            console.log("{{ user }}")
            // csrf token
            const csrftoken = getCookie('csrftoken');
            // query data defines query params
            let queryData = {
                'setTime': '',
                'setStatus': '',
                'keyword': '',
                'user': '',
            }
            // 用户不登录无法看到操作按钮，登录后无需判断
            class User {
                constructor(id, username, is_authenticated) {
                    this.id = id;
                    this.username = username;
                    this.is_authenticated = is_authenticated
                }

                get_object_permissions (obj) {
                    // get user's permissions
                    // obj -> str process id


                }

                action () {
                    // do actions
                }


            }
            // process objects
            // receive, display, & functional events
            class ProcessObject {

                constructor(obj) {
                    this.process_order_id = obj.process_order_id;
                    this.process_owner = obj.process_owner;
                    this.project_name = obj.project_name
                    this.process_status = obj.process_status;
                    this.create_time = obj.create_time;
                    this.target_detail = obj.target_detail;
                }

                static instance = new Set()

                static id_lists = new Set()

                static create(info) {

                    let obj_data = {
                        'process_order_id': info.process_order_id,
                        'process_owner': info.process_owner,
                        'create_time': info.create_time,
                        // 已按step seq 、step seq 排序，
                        'project_name': info.tasks[info.tasks.length - 1].steps[info.tasks[info.tasks.length - 1].steps.length - 1].step_attachment_snapshot[0].fields.project_name,
                        'process_status': info.status,
                        'target_detail': info.target_detail,
                    }

                    if (this.check(obj_data)) {
                        // not created
                        let tmp = new ProcessObject(obj_data);
                        this.instance.add(tmp)
                        this.id_lists.add(tmp.process_order_id)
                        return tmp;
                    } else {
                        let tmp = this.get_obj(obj_data.process_order_id)
                        // update
                        for (let key in obj_data) {

                            if (tmp[key] !== obj_data[key]) {
                                tmp[key] = obj_data[key]
                            }
                        }
                        return tmp
                    }

                }

                static get_obj(pid) {

                    for (const value of this.instance) {
                        if (value.process_order_id === pid) {
                            return value
                        }
                    }
                }

                get_current_user_permission_against_obj () {

                }


                static check(obj) {
                    return !this.id_lists.has(obj.process_order_id);
                }

                display() {
                    return "<tr>" +
                        "<td><a href='" + this.target_detail + "'>" + this.process_order_id + "</a></td>" +
                        "<td>" + this.project_name + "</td>" +
                        "<td>" + this.process_owner + "</td>" +
                        "</tr>"
                }

                check_authorization() {
                    // check if {{ user.pk }} is administrator


                    // check if user has permissions

                    //

                }


            }

            // build block
            $("#breadcrumbRightSide").append(
                "<ol class='breadcrumb' id='title-right-side'>" +
                "<li class='backToMainButton'><a href='javascript:void(0)' data-target='0' data-action='topFilter'>所有课题</a></li>" +
                "<li class='backToMainButton'><a href='javascript:void(0)' data-target='1' data-action='topFilter'>我的课题</a></li>" +
                "</ol>"
            )

            // reused funcs
            function get_process_list(link) {
                // 向后端请求数据并创建相关obj
                $.ajax({
                    url: link,
                    type: "get",
                    success: function (data) {
                        if (data.count > 0) {
                            $("tbody[class=displayProcessObj]").first().empty();
                            for (let k of data.results) {
                                let p = ProcessObject.create(k);

                                $("tbody[class=displayProcessObj]").first().append(p.display())
                            }
                        } else {
                            $("tbody[class=displayProcessObj]").first().empty();
                        }
                        $("#totalBySearch").text(data.count)
                    }
                })
            }

            // bind events
            // top right position , filter if projects are created by user themselves
            $("a[data-action=topFilter]").on("click", function () {
                let ch = this
                $("a[data-action=topFilter]").each(function (idx, val) {

                    if (val === ch) {
                        $(this).css("background-color", "#337b8e");
                        $(this).css("color", "#FFFFFF");
                    } else {
                        $(this).css("background-color", "");
                        $(this).css("color", "#676A6C");
                    }
                })
                // todo: add wait process,
                if ($(this).data("target") === 0) {
                    // all projects,
                    queryData["user"] = "";
                    let url =  genUrl()
                    get_process_list(url)
                } else if ($(this).data("target") === 1) {
                    let user_is_authenticated = ("{{ user.is_authenticated }}".toLowerCase() === 'true');
                    if (user_is_authenticated === true) {
                        queryData["user"] = "{{ user.pk }}";
                        let url = genUrl()
                        get_process_list(url)
                    } else {
                        window.location.href = "/members/login_to_app/"
                    }
                }
            })

            $("a[data-action=setTime]").on("click", function () {
                const val = $(this).text()
                $("a[data-action=setTime]").each(function (idx, element) {
                    $(element).css("background-color", "")
                })
                $(this).css("background-color", "#b6effb")
                $("#setTimeResult").text(val)
                queryData.setTime = $(this).attr("data-days");
            })
            $("#setTimeResult").on("click", function () {
                const val = $(this).text();

                $("a[data-action=setTime]").each(function () {
                    if ($(this).text() === val) {
                        $(this).css("background-color", "")
                    }
                })
                $(this).text("");
                queryData.setTime = ""

            })

            $("a[data-action=setStatus]").on("click", function () {
                const val = $(this).text()
                $("a[data-action=setStatus]").each(function (idx, element) {
                    $(element).css("background-color", "")
                });
                $(this).css("background-color", "#b6effb")
                $("#setStatusResult").text(val)
                queryData.setStatus = $(this).attr("data-id");

            })
            $("#setStatusResult").on("click", function () {
                const val = $(this).text();

                $("a[data-action=setStatus]").each(function () {
                    if ($(this).text() === val) {
                        $(this).css("background-color", "")
                    }
                })
                queryData.setStatus = ""
                $(this).text("");

            })
            $("#keywordSearch").on("change", function () {
                const val = $(this).val()
                queryData.keyword = $(this).val();

                $("#keywordResult").text(val)

            })
            $("#keywordResult").on("click", function () {
                $("#keywordSearch").val("")
                $(this).text("");
                queryData.keyword = "";

            })

            function genUrl() {
                let url = "/projectSystem/processList/?format=json"

                if (queryData["setTime"] !== "") {
                    let currentDate = new Date()
                    let duration = parseInt(queryData["setTime"])
                    if (duration > currentDate.getFullYear() - 10) {
                        // 查询当年1月1日00：00：00到12月31日23：59：59之间的记录
                        let endDate = new Date()
                        currentDate.setFullYear(duration, 0, 1);
                        currentDate.setHours(0, 0, 0)
                        endDate.setFullYear(duration, 11, 31);
                        endDate.setHours(23, 59, 59)
                        url += "&create_time__gte=" + currentDate.format("yyyy-MM-dd hh:mm:ss")
                            + "&create_time__lt=" + endDate.format("yyyy-MM-dd hh:mm:ss");
                    } else {
                        let q_date = addDays(currentDate, 0 - parseInt(queryData["setTime"]));
                        url += "&create_time__gte=" + q_date.format("yyyy-MM-dd hh:mm:ss");
                    }
                }
                if (queryData["setStatus"] !== "") {
                    // status
                    // all - 0 - null
                    if (queryData["setStatus"] !== "0") {
                        url += "&status=" + queryData["setStatus"];
                    }
                }
                if (queryData["keyword"] !== "") {
                    url += "&search_value=" + queryData["keyword"]
                }
                if (queryData["user"] !== "") {
                    url += "&process_owner=" + queryData["user"]
                }
                return url
            }

            $("button[data-action=search]").on("click", function () {
                let url =  genUrl();
                get_process_list(url)
            })
            $("button[data-action=refreshBtn]").on("click", function () {
                $("a[data-action=setTime]").each(function (idx, element) {
                    $(element).css("background-color", "")
                });
                $("a[data-action=setStatus]").each(function (idx, element) {
                    $(element).css("background-color", "")
                });
                $("#keywordSearch").val("");
                for (let val in queryData) {
                    if (val !== "user") {
                        queryData[val] = "";
                    }

                }
                $(".badge").each(function () {
                    $(this).text("")

                })
                get_process_list(genUrl())
            });
        })

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function csrfSafeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function addDays(date, days) {
            var result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        Date.prototype.format = function (fmt) {
            var o = {
                "M+": this.getMonth() + 1,                 //月份
                "d+": this.getDate(),                    //日
                "h+": this.getHours(),                   //小时
                "m+": this.getMinutes(),                 //分
                "s+": this.getSeconds(),                 //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds()             //毫秒
            };
            if (/(y+)/.test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            }
            for (var k in o) {
                if (new RegExp("(" + k + ")").test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                }
            }
            return fmt;
        }

    </script>
{% endblock %}