{% extends 'projectBase.html' %}

{% block content %}
    <div class="row" style="margin:10px">
        <div class="col-md-4">
            <ul style="list-style: none">
                <li>书名：<span id="bookName">{{ book.book_name }}</span></li>
                <li>作者：<span id="authorName">{{ book.author }}</span></li>
                <li>日期：<span id="updateTime">{{ book.update_time|date:"Y年n月d日" }}</span></li>
            </ul>
        </div>
        <div>
            <ul style="list-style: none">
                <li class="d-flex">
                    <span><label for="newBookName">New Book Name</label></span>
                    <input id="newBookName"></li>
                <li class="d-flex">
                    <span><label for="newAuthor">New Author</label></span>
                    <input id="newAuthor">
                </li>
            </ul>
        </div>
    </div>
    <button id='test'>test</button>
    <div class="row">
        {% if process %}
            <p>流程：{{ process }}</p>
        {% endif %}
    </div>

    {#    <div class="row">#}
    {#        {% if task %}#}
    {#            {% for item in task %}#}
    {#                <p>任务{{ forloop.counter }}：{{ item }}</p>#}
    {#            {% endfor %}#}
    {#        {% endif %}#}
    {#    </div>#}
    {#    <div class="row">#}
    {#        {% if step %}#}
    {#            {% for item in step %}#}
    {#                {{ item|safe }}#}
    {#            {% endfor %}#}
    {#        {% endif %}#}
    {#    </div>#}
    <form>
        <label for="taskID">输入TASK ID</label>
        <input id="taskID">
    </form>

    <div class="row">
        <div class="col-md-8">
            <div>
                <ul style="list-style: none" id="stepsDisplayPanel">

                </ul>
            </div>
        </div>

    </div>
    <button id="getSteps">get steps</button>
    <script>

        $(document).ready(function () {
            const csrftoken = getCookie('csrftoken');
            $("#test").on('click', function () {
                {#const csrftoken = getCookie('csrftoken');#}
                let newBook = $("#newBookName")[0].value
                let newAuthor = $("#newAuthor")[0].value
                $.ajax({
                    url: '/projectSystem/books/1.json',
                    data: {
                        'book_name': newBook,
                        'author': newAuthor,
                    },
                    type: 'patch',
                    beforeSend: function (xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader('X-CSRFToken', csrftoken);
                        }
                    },
                    success: function (data) {
                        console.log(data)
                        console.log(typeof data.update_time)
                        $("#bookName")[0].innerText = data.book_name
                        $("#authorName")[0].innerText = data.author

                        $("#updateTime")[0].innerText = data.update_time
                        $("#newBookName")[0].value = ""
                        $("#newAuthor")[0].value = ""
                    }
                })
            })
            $("#getSteps").on("click", function () {
                let url = '/projectSystem/tasks/steps/' + $("#taskID")[0].value
                $.ajax({
                    url: url,
                    type: 'get',
                    beforeSend: function (xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader('X-CSRFToken', csrftoken);
                        }
                    },
                    success: function (data) {
                        let stepTags = "";

                        console.log(typeof data)

                        for (let i = 0; i < data.length; i++) {

                            let snapshot = data[i].step_attachment_snapshot
                            let snapshotJson = ""
                            if (snapshot != null) {
                                console.log(snapshot)
                                snapshotJson = JSON.stringify(snapshot)
                            }
                            stepTags += "<li>" + "步骤ID：" + data[i].step_id + " 顺序:" + data[i].step_seq + " 归属人:" + data[i].step_owner + " 数据: " + snapshotJson + "</li>"
                        }
                        $("#stepsDisplayPanel").append(stepTags)
                    }
                })

            })

        })

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function csrfSafeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

    </script>
{% endblock %}